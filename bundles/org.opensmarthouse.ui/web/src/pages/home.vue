<template>
  <f7-page stacked name="HomePage" class="page-home" :class="{ 'standard-background': $f7.data.themeOptions.homeBackground === 'standard' }" @page:init="onPageInit" @page:afterin="onPageAfterIn" @page:beforeout="onPageBeforeOut">
    <f7-navbar :large="$f7.data.themeOptions.homeNavbar !== 'simple'" :large-transparent="$f7.data.themeOptions.homeNavbar !== 'simple'" class="home-nav">
      <f7-nav-left>
        <f7-link icon-ios="f7:menu" icon-aurora="f7:menu" icon-md="material:menu" panel-open="left"></f7-link>
      </f7-nav-left>
      <f7-nav-title-large v-if="$f7.data.themeOptions.homeNavbar !== 'simple'" class="home-title-large">
        <span class="today">{{new Date().toLocaleString('default', { weekday: 'long', day: 'numeric', month: 'long' }) }}</span>
        {{title}}
      </f7-nav-title-large>
      <f7-nav-title>
        {{title}}
      </f7-nav-title>
      <f7-nav-right>
        <f7-link icon-ios="f7:sidebar_right" icon-aurora="f7:sidebar_right" icon-md="material:exit_to_app" panel-open="right"></f7-link>
      </f7-nav-right>
    </f7-navbar>

    <f7-toolbar tabbar labels bottom>
      <f7-link tab-link @click="currentTab = 'overview'" :tab-link-active="currentTab === 'overview'" icon-ios="f7:house_fill" icon-aurora="f7:house_fill" icon-md="material:home" text="Overview"></f7-link>
      <f7-link tab-link @click="currentTab = 'locations'" :tab-link-active="currentTab === 'locations'" icon-ios="f7:placemark_fill" icon-aurora="f7:placemark_fill" icon-md="material:place" text="Locations"></f7-link>
      <f7-link tab-link @click="currentTab = 'equipments'" :tab-link-active="currentTab === 'equipments'" icon-ios="f7:cube_box_fill" icon-aurora="f7:cube_box_fill" icon-md="material:payments" text="Equipment"></f7-link>
      <f7-link tab-link @click="currentTab = 'properties'" :tab-link-active="currentTab === 'properties'" icon-ios="f7:bolt_fill" icon-aurora="f7:bolt_fill" icon-md="material:flash_on" text="Properties"></f7-link>
    </f7-toolbar>

    <f7-tabs v-if="items">
      <f7-tab id="tab-overview" :tab-active="currentTab === 'overview'" @tab:show="() => this.currentTab = 'overview'">
        <overview-tab v-if="currentTab === 'overview'" :context="context" :items="items" />
      </f7-tab>
      <f7-tab id="tab-locations" :tab-active="currentTab === 'locations'" @tab:show="() => this.currentTab = 'locations'">
        <locations-tab v-if="currentTab === 'locations'" :context="context" :semantic-items="semanticItems" />
      </f7-tab>
      <f7-tab id="tab-equipments" :tab-active="currentTab === 'equipments'" @tab:show="() => this.currentTab = 'equipments'">
        <equipments-tab v-if="currentTab === 'equipments'" :context="context" :semantic-items="semanticItems" />
      </f7-tab>
      <f7-tab id="tab-properties" :tab-active="currentTab === 'properties'" @tab:show="() => this.currentTab = 'properties'">
        <properties-tab v-if="currentTab === 'properties'" :context="context" :semantic-items="semanticItems" />
      </f7-tab>
    </f7-tabs>
  </f7-page>
</template>

<style lang="stylus">
.theme-filled .home-nav .home-title-large .title-large-text
  color var(--f7-text-color)
.theme-filled .home-nav.navbar-large:not(.navbar-large-collapsed) .link.icon-only
  color var(--f7-theme-color)
  transition color 0.3s
.theme-filled .home-nav.navbar-large.navbar-large-collapsed .link.icon-only
  color var(--f7-navbar-link-color)
  transition color 0.3s
.home-nav .home-title-large .title-large-text
  line-height 0.95
  .today
    position absolute
    font-size 8pt
    font-weight normal
    text-transform uppercase
    top -6px
    letter-spacing 1px
    color var(--f7-list-item-footer-text-color)
</style>

<script>
import OverviewTab from './home/overview-tab.vue'
import LocationsTab from './home/locations-tab.vue'
import EquipmentsTab from './home/equipments-tab.vue'
import PropertiesTab from './home/properties-tab.vue'

export default {
  components: {
    OverviewTab,
    LocationsTab,
    EquipmentsTab,
    PropertiesTab
  },
  data () {
    return {
      showSetup: true,
      showTasks: true,
      showCards: false,
      currentTab: 'overview',
      items: [],
      semanticItems: {}
    }
  },
  computed: {
    context () {
      return {
        store: this.$store.getters.trackedItems
      }
    },
    title () {
      switch (this.currentTab) {
        case 'overview':
          return 'Home'
        case 'locations':
          return 'Locations'
        case 'equipments':
          return 'Equipment'
        case 'properties':
          return 'Properties'
        default:
          return 'Home'
      }
    }
  },
  methods: {
    onPageAfterIn () {
      this.$store.dispatch('startTrackingStates')
      this.load()
    },
    onPageBeforeOut () {
      this.$store.dispatch('stopTrackingStates')
    },
    onPageInit () {
      this.$f7.panel.get('left').enableVisibleBreakpoint()
    },
    load () {
      this.$oh.api.get('/rest/items?metadata=semantics,listWidget').then((data) => {
        this.items = data
        // get the location items
        this.semanticItems.locations = data.filter((item, index, items) => {
          return item.metadata && item.metadata.semantics &&
            item.metadata.semantics.value.indexOf('Location') === 0
        }).sort((a, b) => {
          const titleA = a.label || a.name
          const titleB = b.label || b.name
          return titleA.localeCompare(titleB)
        }).map((l) => {
          return {
            item: l,
            properties: data.filter((item, index, items) => {
              return item.metadata && item.metadata.semantics &&
                item.metadata.semantics && item.metadata.semantics.config &&
                item.metadata.semantics.config.relatesTo &&
                item.metadata.semantics.config.hasLocation === l.name
            }),
            equipments: data.filter((item, index, items) => {
              return item.metadata && item.metadata.semantics &&
                item.metadata.semantics && item.metadata.semantics.config &&
                item.metadata.semantics.value.indexOf('Equipment') === 0 &&
                item.metadata.semantics.config.hasLocation === l.name
            }).map((item) => {
              return {
                item: item,
                points: data.filter((item2, index, items) => {
                  return item2.metadata && item2.metadata.semantics &&
                    item2.metadata.semantics && item2.metadata.semantics.config &&
                    item2.metadata.semantics.config.isPointOf === item.name
                })
              }
            })
          }
        })

        // get the equipment items
        this.semanticItems.equipments = data.filter((item, index, items) => {
          return item.metadata && item.metadata.semantics &&
            item.metadata.semantics &&
            item.metadata.semantics.value.indexOf('Equipment') === 0
        }).reduce((prev, item, i, properties) => {
          const equipmentType = item.metadata.semantics.value.split('_')[1] || 'Equipment'
          if (!prev[equipmentType]) prev[equipmentType] = []
          const equipmentWithPoints = {
            item: item,
            points: data.filter((item2, index, items) => {
              return item2.metadata && item2.metadata.semantics &&
                item2.metadata.semantics && item2.metadata.semantics.config &&
                item2.metadata.semantics.config.isPointOf === item.name
            })
          }
          prev[equipmentType].push(equipmentWithPoints)
          return prev
        }, {})

        // get the property items
        this.semanticItems.properties = data.filter((item, index, items) => {
          return item.metadata && item.metadata.semantics &&
            item.metadata.semantics && item.metadata.semantics.config &&
            item.metadata.semantics.config.relatesTo
        }).reduce((prev, item, i, properties) => {
          const property = item.metadata.semantics.config.relatesTo.split('_')[1]
          if (!prev[property]) prev[property] = []
          prev[property].push(item)
          return prev
        }, {})
      })
    }
  }
}
</script>
